stages:
  - build
  - test
  - quality
  - docker
  - security_scan
  - deploy

# ----------------------
# BUILD JOB
# ----------------------
build-app:
  stage: build
  image: python:3.11
  tags: [docker]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never
  before_script:
    - apt-get update && apt-get install -y curl ca-certificates gnupg git php-cli php-mbstring php-xml php-curl php-bcmath php-tokenizer php-zip php-mysql
    - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    - apt-get install -y nodejs unzip
    - php -v && node -v && npm -v
    - curl -sS https://getcomposer.org/installer | php
    - mv composer.phar /usr/local/bin/composer
  script:
    - echo "Installing Laravel dependencies..."
    - composer install --prefer-dist --no-interaction --optimize-autoloader

    - echo "Building Vue frontend (Vite @ root)..."
    - npm install
    - npm run build

    # Copie du manifest (Vite lâ€™Ã©crit dans .vite/)
    - |
      if [ -f public/build/.vite/manifest.json ]; then
        cp -v public/build/.vite/manifest.json public/build/manifest.json
      else
        echo "âŒ .vite/manifest.json manquant" && exit 1
      fi

    - echo "ğŸ” public/build :"
    - ls -la public/build || true
    - test -f public/build/manifest.json || (echo "âŒ public/build/manifest.json manquant" && exit 1)

    # Backend LLM (facultatif)
    - echo "Installing backend-llm dependencies..."
    - cd backend-llm
    - python -m venv venv
    - . venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - echo "ğŸ§ª Fin du build, statut completed"
  artifacts:
    name: "build-app-artifacts"
    expire_in: 1 week
    paths:
      - public/build/
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - node_modules/
      - .npm/
      - .composer/cache/
      - .cache/pip/

# ---------------------------
# UNIT TEST LARAVEL
# ---------------------------
unit-test-laravel:
  stage: test
  image: php:8.2-cli
  tags: [docker]
  coverage: '/Lines:\s+\d+\.\d+\%/'
  dependencies: [build-app]
  variables:
    APP_ENV: testing
    APP_DEBUG: "false"
    APP_URL: http://localhost
    APP_KEY: base64:2fl+Ktvkdg+Fuz4Qp/A75G2RTiWVA/ZoKX87pse8ueM=
    DB_CONNECTION: sqlite
    DB_DATABASE: ":memory:"
    CACHE_DRIVER: array
    SESSION_DRIVER: array
    QUEUE_CONNECTION: sync
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never
  before_script:
    - apt-get update && apt-get install -y build-essential libsqlite3-dev libzip-dev libpng-dev git curl unzip
    - docker-php-ext-install pdo_sqlite zip gd
    - pecl install pcov
    - docker-php-ext-enable pcov
    - echo "pcov.enabled=1" >> /usr/local/etc/php/conf.d/docker-php-ext-pcov.ini
    - echo "pcov.directory=." >> /usr/local/etc/php/conf.d/docker-php-ext-pcov.ini
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --no-interaction --prefer-dist --optimize-autoloader
    - cp -n .env.example .env || true
    - php artisan key:generate --force
    - mkdir -p storage/framework/sessions storage/framework/views storage/framework/cache storage/logs
    - chmod -R 777 storage/
  script:
    - echo "ğŸ” VÃ©rif artifact public/build :"
    - ls -la public/build || true
    - test -f public/build/manifest.json || (echo "âŒ public/build/manifest.json manquant (artifact non rÃ©cupÃ©rÃ©)" && exit 1)
    - php artisan config:clear
    - echo "ğŸ§ª Running tests..."
    - ./vendor/bin/phpunit --configuration phpunit.xml --coverage-text --colors=never --coverage-clover=storage/coverage.xml
    - test -f storage/coverage.xml && echo "âœ… coverage.xml gÃ©nÃ©rÃ©" || (echo "âŒ coverage.xml absent" && exit 1)
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - storage/coverage.xml


# ----------------------
# UNIT TEST FRONTEND (VUE)
# ----------------------
unit-test-frontend:
  stage: test
  image: node:20
  tags: [docker]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never
  variables:
    NODE_ENV: test
    VITEST: "true"
    VITE_CHATBOT_API_URL: "http://127.0.0.1:5005"
  before_script:
    - npm install --cache .npm --prefer-offline
  script:
    - echo "Running Vue tests with Vitest..."
    - npx vitest run --coverage --silent
  artifacts:
    expire_in: 1 week
    paths: [coverage/]
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)%/'
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths: [.npm/, node_modules/]

# ---------------------------
# UNIT TEST BACKEND-LLM
# ---------------------------
unit-test-backend:
  stage: test
  image: python:3.11
  tags: [docker]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never
  script:
    - cd backend-llm
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install -r requirements-test.txt
    - echo "Running backend-llm tests with coverage..."
    - export PYTHONPATH="${PWD}:${PYTHONPATH}"
    - pytest tests/ --cov=. --cov-report=xml --cov-report=term --maxfail=3 --tb=short --strict-markers
    - echo "ğŸ§ª Fin du test, statut completed"
  artifacts:
    when: always
    expire_in: 1 week
    paths: [backend-llm/coverage.xml]

# ---------------------------
# SonarQube : Analyse
# ---------------------------
sonarqube-check:
  stage: quality
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  tags: [docker]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths: [.sonar/cache]
    policy: pull-push
  dependencies:
    - unit-test-laravel
    - unit-test-frontend
    - unit-test-backend
  before_script:
    - apt-get update && apt-get install -y findutils
    - echo "ğŸ’¡ Lancement de l'analyse SonarQube â€“ prÃ©paration..."
  script:
    - echo "âœ… VÃ©rification des fichiers de couverture..."
    - echo "ğŸ“ Recherche de tous les fichiers coverage.xml :"
    - find . -name "coverage.xml" -type f || echo "Aucun fichier coverage.xml trouvÃ©"
    - find . -name "lcov.info" -type f || echo "Aucun fichier lcov.info trouvÃ©"
    - echo "ğŸ“ Structure des dossiers :"
    - ls -la
    - ls -la storage/ || echo "Dossier storage/ absent"
    - ls -la coverage/ || echo "Dossier coverage/ absent"
    - ls -la backend-llm/ || echo "Dossier backend-llm/ absent"
    - echo "ğŸ” VÃ©rification des fichiers de couverture requis :"
    - |
      if [ -f "storage/coverage.xml" ]; then
        echo "âœ… Laravel coverage trouvÃ© : storage/coverage.xml"
        head -5 storage/coverage.xml
      else
        echo "âŒ Laravel coverage manquant dans storage/coverage.xml"
        find . -name "coverage.xml" -path "*/storage/*" || true
      fi
    - |
      if [ -f "coverage/lcov.info" ]; then
        echo "âœ… Vue coverage trouvÃ© : coverage/lcov.info"
        head -5 coverage/lcov.info
      else
        echo "âŒ Vue coverage manquant dans coverage/lcov.info"
        find . -name "*lcov*" -path "*/coverage/*" || true
        find . -name "*coverage*.xml" -path "*/coverage/*" || true
      fi
    - |
      if [ -f "backend-llm/coverage.xml" ]; then
        echo "âœ… Python coverage trouvÃ© : backend-llm/coverage.xml"
        head -5 backend-llm/coverage.xml
      else
        echo "âŒ Python coverage manquant dans backend-llm/coverage.xml"
        find . -name "coverage.xml" -path "*/backend-llm/*" || true
      fi
    - |
      MISSING_FILES=0
      [ -f "storage/coverage.xml" ] || { echo "âŒ Fichier manquant : storage/coverage.xml"; MISSING_FILES=$((MISSING_FILES + 1)); }
      [ -f "coverage/lcov.info" ]   || { echo "âŒ Fichier manquant : coverage/lcov.info";   MISSING_FILES=$((MISSING_FILES + 1)); }
      [ -f "backend-llm/coverage.xml" ] || { echo "âŒ Fichier manquant : backend-llm/coverage.xml"; MISSING_FILES=$((MISSING_FILES + 1)); }
      if [ $MISSING_FILES -eq 0 ]; then
        echo "ğŸš€ Tous les fichiers de couverture sont prÃ©sents, lancement de l'analyse SonarQube..."
        sonar-scanner \
          -Dsonar.host.url="${SONAR_HOST_URL}" \
          -Dsonar.projectKey="chatbot-app" \
          -Dsonar.projectName="chatbot-app" \
          -Dsonar.projectVersion="1.0" \
          -Dsonar.sources="app,resources/js,backend-llm" \
          -Dsonar.inclusions="app/**/*.php,resources/js/**/*.vue,backend-llm/**/*.py" \
          -Dsonar.exclusions="**/node_modules/**,**/vendor/**,**/tests/**,**/*.spec.js,**/storage/**,**/bootstrap/cache/**,**/public/build/**,**/venv/**,**/.venv/**" \
          -Dsonar.javascript.lcov.reportPaths="coverage/lcov.info" \
          -Dsonar.php.coverage.reportPaths="storage/coverage.xml" \
          -Dsonar.python.coverage.reportPaths="backend-llm/coverage.xml" \
          -Dsonar.sourceEncoding="UTF-8" \
          -Dsonar.scm.disabled=true \
          -Dsonar.cpd.exclusions="**/vendor/**,**/node_modules/**"
      else
        echo "âŒ $MISSING_FILES fichier(s) de couverture manquant(s), analyse SonarQube annulÃ©e"
        exit 1
      fi
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never

# ---------------------------
# Docker (Docker Hub)
# ---------------------------
docker-build-push:
  stage: docker
  image: docker:25.0.3
  tags: [docker]
  services: [docker:25.0.3-dind]
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    DOCKER_BUILDKIT: 1
  script:
    - echo "Connexion Ã  Docker Hub"
    - docker login -u "$DOCKER_HUB_USERNAME" -p "$DOCKER_HUB_PASSWORD"
    - echo "Build & Push Laravel"
    - docker pull "$DOCKER_HUB_USERNAME/chatbot-laravel:latest" || true
    - docker build --cache-from "$DOCKER_HUB_USERNAME/chatbot-laravel:latest" -t "$DOCKER_HUB_USERNAME/chatbot-laravel:latest" -f Dockerfile .
    - docker push "$DOCKER_HUB_USERNAME/chatbot-laravel:latest"
    - echo "Build & Push llm-backend"
    - docker pull "$DOCKER_HUB_USERNAME/chatbot-llm-backend:latest" || true
    - docker build --cache-from "$DOCKER_HUB_USERNAME/chatbot-llm-backend:latest" -t "$DOCKER_HUB_USERNAME/chatbot-llm-backend:latest" -f backend-llm/Dockerfile backend-llm
    - docker push "$DOCKER_HUB_USERNAME/chatbot-llm-backend:latest"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never

# ---------------------------
# Trivy : Scan de vulnÃ©rabilitÃ©s Docker
# ---------------------------
trivy-scan:
  stage: security_scan
  image: docker:latest
  tags: [docker]
  variables:
    TRIVY_TIMEOUT: 20m
    TRIVY_CACHE_DIR: .trivy-cache
    TRIVY_USERNAME: "$DOCKER_HUB_USERNAME"
    TRIVY_PASSWORD: "$DOCKER_HUB_PASSWORD"
  cache:
    key: trivy-db
    paths: [.trivy-cache/]
  before_script:
    - apk add --no-cache curl
    - curl -sSfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s --
    - mv ./bin/trivy /usr/local/bin/trivy
    - trivy --version
    - wget -q -O gitlab.tpl https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/gitlab.tpl || echo '{{}}' > gitlab.tpl
    - trivy image --cache-dir "$TRIVY_CACHE_DIR" --quiet --scanners vuln --severity CRITICAL alpine:3.19 >/dev/null 2>&1 || true
    - |
      retry_trivy() {
        local cmd="$1"; local tries=3; local delay=20
        for i in $(seq 1 $tries); do
          eval "$cmd" && return 0
          echo "Trivy attempt $i/$tries failed; retrying in ${delay}s..."
          sleep $delay
        done
        return 1
      }
  script:
    - echo "Scanning Docker images for vulnerabilities..."
    - export TRIVY_OPTS="--timeout $TRIVY_TIMEOUT --scanners vuln --ignore-unfixed --severity HIGH,CRITICAL --no-progress --cache-dir $TRIVY_CACHE_DIR --skip-java-db-update"
    - export TRIVY_SKIP="--skip-dirs var/www/public/image --skip-files var/www/public/image/startup/investors-group.jpeg"
    - retry_trivy "trivy image $TRIVY_OPTS $TRIVY_SKIP --format json -o rapport-laravel.json \"$DOCKER_HUB_USERNAME/chatbot-laravel:latest\"" || echo '{}' > rapport-laravel.json
    - retry_trivy "trivy image $TRIVY_OPTS $TRIVY_SKIP --format template --template \"@gitlab.tpl\" -o scanning-report.txt \"$DOCKER_HUB_USERNAME/chatbot-laravel:latest\"" || echo '' > scanning-report.txt
    - retry_trivy "trivy image $TRIVY_OPTS $TRIVY_SKIP --format json -o rapport-llm-backend.json \"$DOCKER_HUB_USERNAME/chatbot-llm-backend:latest\"" || echo '{}' > rapport-llm-backend.json
    - echo "Security scan completed"
  allow_failure: true
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - rapport-laravel.json
      - rapport-llm-backend.json
      - scanning-report.txt
    reports:
      container_scanning: scanning-report.txt
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never
  dependencies: [docker-build-push]

# ---------------------------
# DEPLOY
# ---------------------------
deploy-prod:
  stage: deploy
  image: debian:bookworm-slim
  tags: [docker]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
    - when: never
  variables:
    ANSIBLE_HOST_KEY_CHECKING: "false"
  before_script:
    - apt-get update && apt-get install -y openssh-client bash curl coreutils
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H 13.37.67.20 >> ~/.ssh/known_hosts 2>/dev/null
    - test -n "${ENV_PROD_FILE:-}" || { echo "âŒ ENV_PROD_FILE non dÃ©fini (variable CI)"; exit 1; }
    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@13.37.67.20 'echo "SSH OK"'
  script:
    - echo "ğŸš€ DÃ©ploiement production"

    # 0) PrÃ©parer rÃ©pertoire sur le serveur
    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@13.37.67.20 '
        set -euo pipefail
        sudo mkdir -p /home/ubuntu/chatbot
        sudo chown -R ubuntu:ubuntu /home/ubuntu/chatbot
      '

    # 1) Ã‰crire le .env
    - |
      if [ -f "$ENV_PROD_FILE" ]; then
        echo "âœï¸  Envoi .env (mode File)"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@13.37.67.20 "cat > /home/ubuntu/chatbot/.env" < "$ENV_PROD_FILE"
      else
        echo "âœï¸  Envoi .env (mode texte)"
        printf "%s" "$ENV_PROD_FILE" | ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@13.37.67.20 "cat > /home/ubuntu/chatbot/.env"
      fi

    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@13.37.67.20 '
        set -euo pipefail
        sed -i -e "s/\r$//" /home/ubuntu/chatbot/.env || true
        [ -d /home/ubuntu/chatbot/.env.prod ] && rm -rf /home/ubuntu/chatbot/.env.prod || true
        echo "âœ… .env Ã©crit : $(wc -l < /home/ubuntu/chatbot/.env) lignes"
      '

    # 2) Docker/Compose OK + pull code/images
    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@13.37.67.20 '
        set -euo pipefail
        cd /home/ubuntu/chatbot
        export DOCKER_HOST=unix:///run/docker.sock
        sudo systemctl start docker || true
        if docker compose version >/dev/null 2>&1; then
          COMPOSE="sudo docker compose"
        elif command -v docker-compose >/dev/null 2>&1; then
          COMPOSE="sudo docker-compose"
        else
          sudo apt-get update -y && (sudo apt-get install -y docker-compose-plugin || sudo apt-get install -y docker-compose)
          if docker compose version >/dev/null 2>&1; then COMPOSE="sudo docker compose"; else COMPOSE="sudo docker-compose"; fi
        fi
        echo "ğŸ“¥ git pull ..."; git pull origin main || true
        echo "ğŸ“¦ Pull images ..."; $COMPOSE pull
      '

    # 3) Recreate/Restart containers
    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@13.37.67.20 '
        set -euo pipefail
        cd /home/ubuntu/chatbot
        if docker compose version >/dev/null 2>&1; then COMPOSE="sudo docker compose"; else COMPOSE="sudo docker-compose"; fi
        echo "ğŸ”„ Restart containers ..."
        $COMPOSE down || true
        $COMPOSE up -d --remove-orphans
        echo "âœ… Containers dÃ©marrÃ©s"
        $COMPOSE ps
      '

    # 4) Purger caches Laravel + APP_KEY + Ã©tat migrations
    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@13.37.67.20 '
        set -euo pipefail
        cd /home/ubuntu/chatbot
        if docker compose version >/dev/null 2>&1; then COMPOSE="sudo docker compose"; else COMPOSE="sudo docker-compose"; fi
        echo "ğŸ§¹ Artisan: clear/config/cache"
        $COMPOSE exec -T laravel bash -lc "
          set -e
          cd /var/www
          php artisan config:clear || true
          php artisan cache:clear || true
          if ! grep -q \"^APP_KEY=\" .env || [ -z \"\$(grep \"^APP_KEY=\" .env | cut -d= -f2)\" ]; then
            echo 'âš ï¸  APP_KEY manquant â†’ gÃ©nÃ©ration'
            php artisan key:generate --force
          fi
          php artisan migrate:status -v || true
        "
      '

    # 5) (Optionnel) Refresh DB + seed si RUN_DB_REFRESH=true
    - |
      if [ "${RUN_DB_REFRESH:-false}" = "true" ]; then
        echo "âš ï¸  RUN_DB_REFRESH=true â†’ migrate:fresh --seed (DESTRUCTIF)"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@13.37.67.20 '
          set -euo pipefail
          cd /home/ubuntu/chatbot
          if docker compose version >/dev/null 2>&1; then COMPOSE="sudo docker compose"; else COMPOSE="sudo docker-compose"; fi
          $COMPOSE exec -T laravel bash -lc "cd /var/www && php artisan migrate:fresh --seed --force"
        '
      else
        echo "â­ï¸  RUN_DB_REFRESH != true â†’ on saute le refresh DB"
      fi

    # 6) Health check HTTP
    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@13.37.67.20 '
        set -euo pipefail
        cd /home/ubuntu/chatbot
        if docker compose version >/dev/null 2>&1; then COMPOSE="sudo docker compose"; else COMPOSE="sudo docker-compose"; fi

        echo "ğŸ¥ Health check ..."
        for i in {1..30}; do
          if curl -fsS http://localhost/health-check >/dev/null 2>&1; then
            # Optionnel : tester aussi lâ€™API LLM via Nginx; ne bloque pas le dÃ©ploiement
            curl -fsS http://localhost/ping >/dev/null 2>&1 || true
            echo "âœ… Health OK"
            exit 0
          fi
          sleep 3
        done

        echo "âš ï¸ Health KO â€” derniers logs :"
        $COMPOSE logs --tail=120 || true
        exit 1
      '

    - echo "ğŸ‰ DÃ©ploiement terminÃ© avec succÃ¨s !"

  after_script:
    - echo "ğŸ“Š Fin de dÃ©ploiement Ã  $(date)"
  when: manual

